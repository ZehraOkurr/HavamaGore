@model List<HavamaGore.Models.Message>

@{
    ViewData["Title"] = "Sohbet";
    var chatUser = ViewBag.CurrentChatUser as string;
    var myName = Context.Session.GetString("Username");
}

<div class="container" style="padding-top: 130px; padding-bottom: 50px;">
    
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="glass-card overflow-hidden shadow-lg" style="height: 70vh; display: flex; flex-direction: column;">
                
                <div class="p-3 border-bottom border-secondary bg-dark bg-opacity-50 d-flex align-items-center">
                    <a asp-controller="Social" asp-action="Index" class="btn btn-sm btn-outline-light rounded-circle me-3"><i class="fas fa-arrow-left"></i></a>
                    <img src="https://ui-avatars.com/api/?name=@chatUser&background=random" class="rounded-circle shadow-sm me-3" width="40">
                    <h5 class="mb-0 text-white fw-bold">@chatUser</h5>
                </div>

                <div id="chatBox" class="flex-grow-1 p-4" style="overflow-y: auto; background: rgba(0,0,0,0.2);">
                    @if (Model.Count == 0)
                    {
                        <div class="text-center text-white-50 mt-5">
                            <i class="far fa-comments fa-3x mb-3"></i>
                            <p>HenÃ¼z mesaj yok. Ä°lk merhaba'yÄ± sen de! ðŸ‘‹</p>
                        </div>
                    }
                    else
                    {
                        @foreach (var msg in Model)
                        {
                            bool isMe = msg.SenderUsername == myName;
                            <div class="d-flex mb-3 @(isMe ? "justify-content-end" : "justify-content-start")">
                                <div class="p-3 rounded-4 shadow-sm text-white" 
                                     style="max-width: 70%; background: @(isMe ? "#0d6efd" : "#343a40"); 
                                            border-bottom-@(isMe ? "right" : "left")-radius: 0;">
                                    <p class="mb-1">@msg.Content</p>
                                    <small class="text-white-50" style="font-size: 10px;">@msg.Timestamp.ToString("HH:mm")</small>
                                </div>
                            </div>
                        }
                    }
                </div>

                <div class="p-3 border-top border-secondary bg-dark bg-opacity-50">
                    <div class="input-group">
                        <input type="text" id="msgInput" class="form-control rounded-pill bg-transparent text-white border-secondary" placeholder="Bir ÅŸeyler yaz..." autocomplete="off">
                        <button onclick="sendMessage()" class="btn btn-primary rounded-circle ms-2" style="width: 45px; height: 45px;">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    // Sayfa aÃ§Ä±lÄ±nca en alta kaydÄ±r
    var chatBox = document.getElementById("chatBox");
    chatBox.scrollTop = chatBox.scrollHeight;

    function sendMessage() {
        var input = document.getElementById("msgInput");
        var text = input.value;
        if (!text.trim()) return;

        var receiver = "@chatUser";

        fetch('/Chat/SendMessage?receiver=' + receiver + '&content=' + text, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                // SayfayÄ± yenilemek yerine JS ile mesajÄ± ekleyebilirdik ama ÅŸimdilik en kolayÄ± reload
                location.reload(); 
            }
        });
    }

    // Enter'a basÄ±nca gÃ¶nder
    document.getElementById("msgInput").addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            sendMessage();
        }
    });
</script>