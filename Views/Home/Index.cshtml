@using System.Linq 
@model HavamaGore.Models.HomeViewModel

@{
    ViewData["Title"] = "Ana Sayfa";
    
    // --- HAVA DURUMU ---
    string weatherClass = "weather-default";
    string condition = Model?.Weather?.Current?.Condition?.Text?.ToLower() ?? "";
    string weatherIcon = "sun";

    if (condition.Contains("fog") || condition.Contains("mist") || condition.Contains("sis")) { weatherClass = "weather-foggy"; weatherIcon="smog"; }
    else if (condition.Contains("rain") || condition.Contains("yağmur")) { weatherClass = "weather-rainy"; weatherIcon="cloud-showers-heavy"; }
    else if (condition.Contains("snow") || condition.Contains("kar")) { weatherClass = "weather-snow"; weatherIcon="snowflake"; }
    else if (condition.Contains("sunny") || condition.Contains("clear") || condition.Contains("güneş") || condition.Contains("açık")) { weatherClass = "weather-sunny"; weatherIcon="sun"; }
}

<script>document.body.className = "@weatherClass";</script>

<style>
    /* Modal ve Animasyon Stilleri */
    .modal-backdrop { background-color: rgba(0, 0, 0, 0.6) !important; backdrop-filter: blur(15px); }
    .modal-content { background: rgba(30, 30, 30, 0.95); border: none; box-shadow: 0 0 50px rgba(0,0,0,0.5); color: white; }
    
    @@keyframes heartbeat { 
        0% { transform: scale(1); } 
        50% { transform: scale(1.3); } 
        100% { transform: scale(1); } 
    }
    
    .heart-beat { animation: heartbeat 0.3s ease-in-out; }
    .fas.fa-heart { color: #e74c3c !important; }
    .hover-scale { transition: transform 0.3s; }
    .hover-scale:hover { transform: scale(1.05); }
    .scroll-btn { position: absolute; top: 50%; transform: translateY(-50%); z-index: 10; background: rgba(0,0,0,0.7); border: none; color: white; border-radius: 50%; width: 40px; height: 40px; }
    .scroll-btn.left { left: 0; } .scroll-btn.right { right: 0; }
    .slider-wrapper { position: relative; padding: 0 20px; }
</style>

@if (weatherClass == "weather-sunny") { <div class="sun-rays"></div> }
@if (weatherClass == "weather-cloudy" || weatherClass == "weather-foggy") { <div class="cloud"></div><div class="cloud" style="top:40%; animation-duration: 35s; opacity:0.5;"></div> }
@if (weatherClass == "weather-rainy") { <div id="rain-container"></div> }

<div class="container pb-5" style="padding-top: 130px;">

    <div class="d-flex justify-content-between align-items-end mb-4">
        <div class="text-start">
            <div class="d-inline-flex align-items-center bg-white bg-opacity-10 px-3 py-1 rounded-pill border border-white border-opacity-25 mb-3">
                <i class="fas fa-@weatherIcon text-warning me-2"></i>
                <span class="text-white small fw-bold text-uppercase">@Model?.RecommendedGenreName Modu</span>
            </div>
            <h1 class="display-4 fw-bold text-shadow text-white mb-0">HavamaGöre</h1>
            <p class="fs-5 text-white-50 mb-0 text-shadow">@Model?.RecommendedGenreName havası hakim.</p>
        </div>
        <button class="btn btn-light rounded-pill px-4 py-2 shadow fw-bold" data-bs-toggle="modal" data-bs-target="#locationModal">
            📍 @(Model?.City ?? "Konum Seç") <span class="small text-muted ms-1">Değiştir</span>
        </button>
    </div>

    <div class="text-center mb-5">
        <button onclick="getDailyProposal()" class="btn btn-light btn-lg rounded-pill px-5 py-3 shadow-lg fw-bold hover-scale" style="border: 4px solid rgba(255,255,255,0.5);">
            <i class="fas fa-dice fa-2x me-2 text-primary align-middle"></i>
            <span class="align-middle fs-4">Bugün Ne Yapmalıyım?</span>
        </button>
    </div>

    @if (Model != null && Model.Weather != null)
    {
        <div id="heroCarousel" class="carousel slide mb-5 shadow-lg rounded-4 overflow-hidden" data-bs-ride="carousel">
            <div class="carousel-indicators">
                <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="0" class="active"></button>
                <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="1"></button>
                <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="2"></button>
            </div>
            <div class="carousel-inner">
                
                @if(Model.Movies?.Results?.Count > 0)
                {
                    var m = Model.Movies.Results.First();
                    var safeTitle = m.Title?.Replace("'", "\\'") ?? "";
                    var safeOverview = m.Overview?.Replace("'", "\\'")?.Replace("\n", " ") ?? "";

                    <div class="carousel-item active" style="height: 500px;">
                        <div class="d-flex h-100 position-relative">
                            <div style="position:absolute; inset:0; background: url('https://image.tmdb.org/t/p/original/@m.PosterPath') center/cover; filter: blur(20px);"></div>
                            <div style="position:absolute; inset:0; background: rgba(0,0,0,0.5);"></div>
                            <div class="row align-items-center w-100 h-100 position-relative z-2 p-5 mx-0">
                                <div class="col-md-4 text-center"><img src="https://image.tmdb.org/t/p/w500/@m.PosterPath" class="rounded-4 shadow-lg" style="max-height: 400px;"></div>
                                <div class="col-md-8 text-white">
                                    <span class="badge bg-warning text-dark mb-2">🎬 Günün Filmi</span>
                                    <h1 class="display-4 fw-bold">@m.Title</h1>
                                    <p class="lead opacity-75 text-truncate">@m.Overview</p>
                                    <div class="mt-4">
                                        <button class="btn btn-primary rounded-pill px-4 py-2 me-2" onclick="openDetailModal('@safeTitle', '@safeOverview', 'https://image.tmdb.org/t/p/w500/@m.PosterPath', '@m.VoteAverage', '@m.Id', 'Movie')">İncele & Yorumla</button>
                                        <button class="btn btn-outline-light rounded-circle p-2" onclick="addToLibrary(this, '@safeTitle', 'Movie', 'https://image.tmdb.org/t/p/w500/@m.PosterPath', '@safeOverview', '')"><i class="far fa-heart fa-lg"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }

                @if(Model.Musics != null && Model.Musics.Count > 0)
                {
                    var heroMusic = Model.Musics.FirstOrDefault();
                    if(heroMusic != null) {
                        string imgUrl = (heroMusic.Images?.Count > 0) ? heroMusic.Images[0].Url : "";
                        var safeName = heroMusic.Name?.Replace("'", "\\'") ?? "";
                        var safeDesc = heroMusic.Description?.Replace("'", "\\'") ?? "";

                        <div class="carousel-item" style="height: 500px;">
                            <div class="d-flex h-100 position-relative">
                                 <div style="position:absolute; inset:0; background: url('@imgUrl') center/cover; filter: blur(20px);"></div>
                                 <div style="position:absolute; inset:0; background: rgba(0,0,0,0.6);"></div>
                                 <div class="row align-items-center w-100 h-100 position-relative z-2 p-5 mx-0">
                                    <div class="col-md-4 text-center">
                                        <img src="@imgUrl" class="rounded-circle shadow-lg" style="width: 350px; height: 350px; object-fit: cover; border: 5px solid rgba(255,255,255,0.2);">
                                    </div>
                                    <div class="col-md-8 text-white">
                                        <span class="badge bg-success mb-2">🎧 Günün Ritmi</span>
                                        <h1 class="display-4 fw-bold">@heroMusic.Name</h1>
                                        <p class="lead opacity-75">@heroMusic.Description</p>
                                        <div class="mt-4">
                                            <a href="@heroMusic.ExternalUrls.Spotify" target="_blank" class="btn btn-success rounded-pill px-4 py-2 me-2">Spotify'da Dinle</a>
                                            <button class="btn btn-outline-light rounded-circle p-2" onclick="addToLibrary(this, '@safeName', 'Music', '@imgUrl', '@safeDesc', '@heroMusic.ExternalUrls.Spotify')"><i class="far fa-heart fa-lg"></i></button>
                                        </div>
                                    </div>
                                 </div>
                            </div>
                        </div>
                    }
                }

                @if(Model.Books?.Items?.Count > 0)
                {
                    var heroBook = Model.Books.Items.First();
                    string bookImg = heroBook.VolumeInfo.ImageLinks?.Thumbnail ?? "";
                    string authors = heroBook.VolumeInfo.Authors != null ? string.Join(", ", heroBook.VolumeInfo.Authors) : "Yazar Bilinmiyor";
                    string pageCount = heroBook.VolumeInfo.PageCount.HasValue ? heroBook.VolumeInfo.PageCount.ToString() : "0";
                    var safeTitle = heroBook.VolumeInfo.Title?.Replace("'", "\\'") ?? "";
                    var safeDesc = heroBook.VolumeInfo.Description?.Replace("'", "\\'")?.Replace("\n", " ") ?? "";
                    var safeAuthors = authors.Replace("'", "\\'");

                    <div class="carousel-item" style="height: 500px;">
                        <div class="d-flex h-100 position-relative">
                             <div style="position:absolute; inset:0; background: url('@bookImg') center/cover; filter: blur(20px);"></div>
                             <div style="position:absolute; inset:0; background: rgba(0,0,0,0.6);"></div>
                             <div class="row align-items-center w-100 h-100 position-relative z-2 p-5 mx-0">
                                <div class="col-md-4 text-center">
                                    <img src="@bookImg" class="shadow-lg rounded-3" style="height: 350px; object-fit: cover; border: 3px solid white;">
                                </div>
                                <div class="col-md-8 text-white">
                                    <span class="badge bg-primary mb-2">📖 Günün Kitabı</span>
                                    <h1 class="display-4 fw-bold">@heroBook.VolumeInfo.Title</h1>
                                    <p class="fs-5 text-warning mb-2">✍️ @authors</p>
                                    <p class="lead opacity-75 text-truncate" style="max-width: 600px;">@(heroBook.VolumeInfo.Description ?? "Açıklama bulunamadı.")</p>
                                    <div class="mt-4">
                                        <button class="btn btn-primary rounded-pill px-4 py-2 me-2" onclick="openDetailModal('@safeTitle', '@safeDesc', '@bookImg', '4.5', '@heroBook.Id', 'Book', '@safeAuthors', '@pageCount')">İncele & Yorumla</button>
                                        <button class="btn btn-outline-light rounded-circle p-2" onclick="addToLibrary(this, '@safeTitle', 'Book', '@bookImg', '@safeAuthors', '@heroBook.VolumeInfo.PreviewLink')"><i class="far fa-heart fa-lg"></i></button>
                                    </div>
                                </div>
                             </div>
                        </div>
                    </div>
                }
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#heroCarousel" data-bs-slide="prev"><span class="carousel-control-prev-icon"></span></button>
            <button class="carousel-control-next" type="button" data-bs-target="#heroCarousel" data-bs-slide="next"><span class="carousel-control-next-icon"></span></button>
        </div>

        @if(Model.Movies?.Results?.Count > 0)
        {
            <h3 class="text-white mb-3 fw-bold text-shadow">🍿 Senin İçin Seçtiklerimiz</h3>
            <div class="slider-wrapper mb-5">
                <button class="scroll-btn left" onclick="scrollContainer('movieList', 'left')"><i class="fas fa-chevron-left"></i></button>
                <div class="movie-scroll-container" id="movieList">
                    @foreach (var movie in Model.Movies.Results.Skip(1))
                    {
                        var safeTitle = movie.Title?.Replace("'", "\\'") ?? "";
                        var safeOverview = movie.Overview?.Replace("'", "\\'")?.Replace("\n", " ") ?? "";

                        <div class="movie-card-modern text-white">
                            <div class="position-relative" style="height: 380px;">
                                 @if (!string.IsNullOrEmpty(movie.PosterPath)) { <img src="https://image.tmdb.org/t/p/w500/@movie.PosterPath" class="w-100 h-100" style="object-fit: cover;"> }
                                 <button class="btn btn-light rounded-circle position-absolute top-0 end-0 m-2 shadow-sm" style="width:35px; height:35px; display:flex; align-items:center; justify-content:center; color: #e74c3c;" onclick="addToLibrary(this, '@safeTitle', 'Movie', 'https://image.tmdb.org/t/p/w500/@movie.PosterPath', '@safeOverview', '')"><i class="far fa-heart"></i></button>
                            </div>
                            <div class="p-3 d-flex flex-column flex-grow-1" style="background: rgba(0,0,0,0.4);">
                                <h5 class="fw-bold text-truncate">@movie.Title</h5>
                                <button class="btn btn-outline-light btn-sm w-100 rounded-pill mt-auto" onclick="openDetailModal('@safeTitle', '@safeOverview', 'https://image.tmdb.org/t/p/w500/@movie.PosterPath', '@movie.VoteAverage', '@movie.Id', 'Movie')">Detay & Yorum</button>
                            </div>
                        </div>
                    }
                </div>
                <button class="scroll-btn right" onclick="scrollContainer('movieList', 'right')"><i class="fas fa-chevron-right"></i></button>
            </div>
        }

        @if(Model.Musics != null && Model.Musics.Count > 0)
        {
            <h3 class="text-white mb-3 fw-bold text-shadow">🎧 Ruh Haline Uygun Müzikler</h3>
            <div class="slider-wrapper mb-5">
                 <button class="scroll-btn left" onclick="scrollContainer('musicList', 'left')"><i class="fas fa-chevron-left"></i></button>
                 <div class="movie-scroll-container" id="musicList">
                    @foreach (var item in Model.Musics)
                    {
                        if (item == null) { continue; }
                        var img = item.Images?.FirstOrDefault()?.Url ?? "";
                        var safeName = item.Name?.Replace("'", "\\'") ?? "";
                        var safeDesc = item.Description?.Replace("'", "\\'") ?? "";

                        <div class="movie-card-modern text-white" style="min-width: 200px;">
                            <div class="position-relative" style="height: 200px;">
                                <img src="@img" class="w-100 h-100" style="object-fit: cover;">
                                <button class="btn btn-light rounded-circle position-absolute top-0 end-0 m-2 shadow-sm" onclick="addToLibrary(this, '@safeName', 'Music', '@img', '@safeDesc', '@item.ExternalUrls.Spotify')"><i class="far fa-heart text-success"></i></button>
                            </div>
                            <div class="p-3 text-center">
                                <h6 class="fw-bold text-truncate">@item.Name</h6>
                                <a href="@item.ExternalUrls.Spotify" target="_blank" class="btn btn-success btn-sm rounded-pill w-100">Dinle</a>
                            </div>
                        </div>
                    }
                 </div>
                 <button class="scroll-btn right" onclick="scrollContainer('musicList', 'right')"><i class="fas fa-chevron-right"></i></button>
            </div>
        }

        @if(Model.Books?.Items?.Count > 0)
        {
            <h3 class="text-white mb-3 fw-bold text-shadow">📖 Okuma Köşesi</h3>
            <div class="slider-wrapper">
                 <button class="scroll-btn left" onclick="scrollContainer('bookList', 'left')"><i class="fas fa-chevron-left"></i></button>
                 <div class="movie-scroll-container" id="bookList">
                    @foreach (var item in Model.Books.Items.Skip(1))
                    {
                        var img = item.VolumeInfo.ImageLinks?.Thumbnail ?? "";
                        var authors = item.VolumeInfo.Authors != null ? string.Join(", ", item.VolumeInfo.Authors) : "Yazar yok";
                        string pageCount = item.VolumeInfo.PageCount.HasValue ? item.VolumeInfo.PageCount.ToString() : "0";
                        var safeTitle = item.VolumeInfo.Title?.Replace("'", "\\'") ?? "";
                        var safeDesc = item.VolumeInfo.Description?.Replace("'", "\\'")?.Replace("\n", " ") ?? "";
                        var safeAuthors = authors.Replace("'", "\\'");

                        <div class="movie-card-modern text-white" style="min-width: 200px; max-width: 200px;">
                            <div class="position-relative" style="height: 280px; overflow: hidden;">
                                @if(!string.IsNullOrEmpty(img)) { <img src="@img" class="w-100 h-100" style="object-fit: cover;"> }
                                <button class="btn btn-light rounded-circle position-absolute top-0 end-0 m-2 shadow-sm" style="width:30px; height:30px; display:flex; align-items:center; justify-content:center; color: #3498db;" onclick="addToLibrary(this, '@safeTitle', 'Book', '@img', '@safeAuthors', '@item.VolumeInfo.PreviewLink')"><i class="far fa-heart"></i></button>
                            </div>
                            <div class="p-3 d-flex flex-column flex-grow-1" style="background: rgba(0,0,0,0.4);">
                                <h6 class="fw-bold text-truncate">@item.VolumeInfo.Title</h6>
                                <p class="small text-white-50 text-truncate">@authors</p>
                                <button class="btn btn-primary btn-sm rounded-pill w-100 mt-auto shadow-sm" onclick="openDetailModal('@safeTitle', '@safeDesc', '@img', '4.0', '@item.Id', 'Book', '@safeAuthors', '@pageCount')">İncele</button>
                            </div>
                        </div>
                    }
                 </div>
                 <button class="scroll-btn right" onclick="scrollContainer('bookList', 'right')"><i class="fas fa-chevron-right"></i></button>
            </div>
        }
    }
</div>

<div class="modal fade" id="proposalModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" style="background: linear-gradient(135deg, #1a1a1a, #2c3e50);">
            <div class="modal-header border-0 text-center justify-content-center position-relative">
                <h2 class="fw-bold mb-0">✨ Günün Kombini ✨</h2>
                <button type="button" class="btn-close btn-close-white position-absolute end-0 top-0 m-3" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-5 text-center">
                <div id="loadingProposal"><div class="spinner-border text-warning" role="status"></div><p class="mt-3">Seçiliyor... 🔮</p></div>
                <div id="proposalContent" style="display:none;">
                    <span class="badge bg-warning text-dark px-3 py-2 rounded-pill mb-4 fs-6" id="propMood">MOOD</span>
                    <div class="row g-4">
                        <div class="col-md-4"><div class="glass-card p-3 h-100"><div class="badge bg-danger mb-2">🎬 Film</div><img id="propMovieImg" src="" class="w-100 rounded-3 mb-2" style="height:150px; object-fit:cover;"><h6 id="propMovieTitle" class="fw-bold text-truncate"></h6></div></div>
                        <div class="col-md-4"><div class="glass-card p-3 h-100"><div class="badge bg-primary mb-2">📖 Kitap</div><img id="propBookImg" src="" class="w-100 rounded-3 mb-2" style="height:150px; object-fit:cover;"><h6 id="propBookTitle" class="fw-bold text-truncate"></h6></div></div>
                        <div class="col-md-4"><div class="glass-card p-3 h-100"><div class="badge bg-success mb-2">🎧 Müzik</div><img id="propMusicImg" src="" class="w-100 rounded-3 mb-2" style="height:150px; object-fit:cover;"><h6 id="propMusicName" class="fw-bold text-truncate"></h6><a id="propMusicLink" href="#" target="_blank" class="btn btn-success btn-sm w-100">Dinle</a></div></div>
                    </div>
                    <button class="btn btn-outline-light rounded-pill px-4 mt-5" onclick="getDailyProposal()"><i class="fas fa-sync-alt me-2"></i>Tekrar Dene</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title fw-bold" id="modalTitle">Başlık</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4"><img id="modalImage" src="" class="w-100 rounded-3 shadow-lg"></div>
                    <div class="col-md-8">
                        <div class="d-flex align-items-center mb-3"><span class="badge bg-warning text-dark me-2" id="modalRating"></span><div id="modalExtraInfo"></div></div>
                        <p id="modalOverview" class="opacity-75 small"></p>
                        <hr class="border-secondary my-4">
                        <h6 class="fw-bold mb-3">💬 Yorum Yap</h6>
                        <textarea id="commentInput" class="form-control bg-dark text-white border-secondary mb-2" rows="2" placeholder="Düşüncelerin..."></textarea>
                        <div class="d-flex justify-content-between">
                            <div class="rating-stars text-warning">
                                <i class="far fa-star" onclick="setRating(1)"></i><i class="far fa-star" onclick="setRating(2)"></i><i class="far fa-star" onclick="setRating(3)"></i><i class="far fa-star" onclick="setRating(4)"></i><i class="far fa-star" onclick="setRating(5)"></i>
                            </div>
                            <button class="btn btn-primary btn-sm rounded-pill px-4" onclick="sendComment()">Gönder</button>
                        </div>
                        <h6 class="fw-bold text-white-50 small mt-4">YORUMLAR</h6>
                        <div id="commentsList" style="max-height: 200px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="locationModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content p-4 text-dark bg-white">
            <h5 class="fw-bold">Konum Seç 🌍</h5>
            <form asp-action="Index" method="get">
                <select id="countrySelect" class="form-select mb-3"><option value="">Ülke Seç</option></select>
                <select id="citySelect" name="city" class="form-select mb-3" disabled></select>
                <button type="submit" class="btn btn-primary w-100">Tamam</button>
            </form>
        </div>
    </div>
</div>

<script>
    // --- SCROLL ---
    function scrollContainer(id, dir) { document.getElementById(id).scrollBy({ left: dir==='left'?-300:300, behavior: 'smooth' }); }

    // --- DETAY MODALI ---
    let currentExternalId="", currentType="", currentRating=0;
    function openDetailModal(title, overview, image, rating, id, type, extra1, extra2) {
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalImage').src = image;
        document.getElementById('modalRating').innerText = "⭐ " + (rating||"N/A");
        document.getElementById('modalOverview').innerText = overview || "Açıklama yok.";
        
        const extraInfoEl = document.getElementById('modalExtraInfo');
        let extraHtml = "";
        if (type === 'Book') {
            if (extra1) extraHtml += `<span class="badge bg-secondary me-2"><i class="fas fa-pen-nib me-1"></i> ${extra1}</span>`;
            if (extra2) extraHtml += `<span class="badge bg-secondary"><i class="fas fa-book-open me-1"></i> ${extra2} Sayfa</span>`;
        } else if (type === 'Movie') {
            if (extra1) extraHtml += `<span class="badge bg-dark me-2">📅 ${extra1}</span>`;
        }
        extraInfoEl.innerHTML = extraHtml;

        currentExternalId = id; currentType = type;
        loadComments(id);
        new bootstrap.Modal(document.getElementById('detailModal')).show();
    }

    function loadComments(id) {
        const list = document.getElementById('commentsList');
        list.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm"></div></div>';
        fetch('/Comment/GetComments?externalId=' + id).then(r=>r.json()).then(data=>{
            list.innerHTML = data.length ? "" : "<p class='text-muted small'>Henüz yorum yok.</p>";
            data.forEach(c => {
                let stars = ""; for(let i=0;i<5;i++) stars += i<c.rating ? '<i class="fas fa-star text-warning"></i>' : '<i class="far fa-star"></i>';
                list.innerHTML += `<div class="border-bottom border-secondary py-2"><div class="d-flex justify-content-between"><small class="fw-bold">${c.username}</small><small>${stars}</small></div><p class="small mb-0 text-white-50">${c.content}</p></div>`;
            });
        });
    }

    function setRating(n) { currentRating = n; document.querySelectorAll('.rating-stars i').forEach((s,i) => { s.className = i<n ? 'fas fa-star' : 'far fa-star'; }); }

    function sendComment() {
        const txt = document.getElementById('commentInput').value;
        if(!txt || currentRating===0) { alert("Puan ve yorum girin!"); return; }
        
        fetch('/Comment/AddComment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                ExternalId: currentExternalId, 
                Type: currentType, 
                Content: txt, 
                Rating: currentRating
            })
        })
        .then(r => r.json())
        .then(d => { 
            if(d.success){ 
                document.getElementById('commentInput').value=""; 
                loadComments(currentExternalId); 
            } else {
                alert(d.message); 
            }
        });
    }

    // --- KÜTÜPHANE EKLEME ---
    function addToLibrary(btn, title, type, img, desc, link) {
        let icon = btn.querySelector('i');
        fetch('/Library/AddItem', {
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({Title:title, Type:type, ImageUrl:img, Overview:desc, ExternalLink:link})
        }).then(r=>r.json()).then(d=> {
            if(d.success) { icon.className="fas fa-heart text-danger"; btn.classList.add('heart-beat'); }
            else alert(d.message);
        });
    }

    // --- BUGÜN NE YAPMALIYIM ---
    function getDailyProposal() {
        new bootstrap.Modal(document.getElementById('proposalModal')).show();
        document.getElementById('loadingProposal').style.display='block';
        document.getElementById('proposalContent').style.display='none';
        fetch('/Home/GetDailyProposal').then(r=>r.json()).then(d=>{
            document.getElementById('propMood').innerText = d.mood;
            document.getElementById('propMovieTitle').innerText=d.movieTitle; document.getElementById('propMovieImg').src=d.movieImg;
            document.getElementById('propBookTitle').innerText=d.bookTitle; document.getElementById('propBookImg').src=d.bookImg;
            document.getElementById('propMusicName').innerText=d.musicName; document.getElementById('propMusicImg').src=d.musicImg; document.getElementById('propMusicLink').href=d.musicLink;
            document.getElementById('loadingProposal').style.display='none';
            document.getElementById('proposalContent').style.display='block';
        });
    }

    // --- KONUM SEÇİMİ ---
    const cityData = { "Türkiye": ["Istanbul", "Ankara", "Izmir", "Bursa"], "ABD": ["New York", "Los Angeles"], "Almanya": ["Berlin", "Munich"] };
    const cSelect = document.getElementById("countrySelect");
    const ciSelect = document.getElementById("citySelect");
    if(cSelect) {
        for(let c in cityData) { let o=document.createElement("option"); o.text=c; cSelect.add(o); }
        cSelect.onchange = function() {
            ciSelect.innerHTML=""; ciSelect.disabled=false;
            cityData[this.value].forEach(c=>{ let o=document.createElement("option"); o.text=c; o.value=c; ciSelect.add(o); });
        };
    }
</script>